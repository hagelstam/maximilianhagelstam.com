---
import Icon from '../components/Icons.astro'
import Layout from '../layouts/Layout.astro'
import { config } from '../config'
import fs from 'fs'
import path from 'path'

interface Article {
  date: string
  title: string
  link: string
  blogName: string
}

const readingPath = path.join(process.cwd(), 'src/content/reading.md')
const articles: Article[] = []

try {
  const content = fs.readFileSync(readingPath, 'utf-8')
  const regex = /^- (\d{2}\.\d{2}\.\d{4}) \[(.*?)\]\((.*?)\) - (.*)$/gm
  let match

  while ((match = regex.exec(content)) !== null) {
    articles.push({
      date: match[1]!,
      title: match[2]!,
      link: match[3]!,
      blogName: match[4]!,
    })
  }
} catch (error) {
  console.error('error parsing reading list:', error)
}

const formatDate = (dateStr: string) => {
  const [day, month, year] = dateStr.split('.')
  const date = new Date(Number(year), Number(month) - 1, Number(day))
  const monthName = date.toLocaleDateString('en-UK', { month: 'short' })
  return `${day} ${monthName} ${year}`
}
---

<Layout title={`Reading list | ${config.site.title}`} header="Reading list">
  <div class="prose prose-neutral prose-invert -mt-3 text-neutral-200">
    <p>
      This page is auto-generated from a GitHub Actions workflow that runs every
      night and fetches the 5 latest articles from my favorite blogs.
    </p>
  </div>

  <div class="mt-8 space-y-6">
    {
      articles.map((article) => (
        <div class="flex items-baseline gap-8">
          <time class="min-w-[100px] text-sm text-neutral-400">
            {formatDate(article.date)}
          </time>
          <div>
            <a
              href={article.link}
              target="_blank"
              rel="noopener noreferrer"
              class="text-neutral-200 transition-all hover:text-neutral-400"
            >
              {article.title}
            </a>
            <span class="ml-2 text-neutral-400">- {article.blogName}</span>
          </div>
        </div>
      ))
    }
  </div>

  <div class="mt-12 border-t border-neutral-800 pt-6">
    <a
      href="https://github.com/hagelstam/maximilianhagelstam.com/blob/main/reading.go"
      target="_blank"
      rel="noopener noreferrer"
      class="inline-flex items-center text-neutral-400 transition-all hover:text-neutral-200"
    >
      <Icon name="arrow" />
      <span class="ml-1">view source code</span>
    </a>
  </div>
</Layout>
